schemaVersion: 2.1.0
metadata:
  name: ansible-devspace
projects:
  - name: basic-devspace
    git:
      remotes:
        origin: ssh://git@github.com/kolliash/start-dev-workspace.git
      checkoutFrom:
        revision: main
components:
  - name: universal-developer-image
    container:
      image: registry.redhat.io/devspaces/udi-rhel8:latest
      memoryLimit: 2Gi
      mountSources: true
      args: ["tail", "-f", "/dev/null"]   # keep container alive
      command: ["/bin/sh", "-c"]
      volumeMounts: []
commands:
  - id: install-ansible
    exec:
      component: universal-developer-image
      commandLine: pip3 install --user ansible-core
      workingDir: ${PROJECTS_ROOT}/basic-devspace
      group:
        kind: build
        isDefault: true

  - id: create-sample-playbook
    exec:
      component: universal-developer-image
      commandLine: |
        cat > ${PROJECTS_ROOT}/basic-devspace/hello.yml <<EOF
        - hosts: localhost
          gather_facts: false
          tasks:
            - name: Print a hello message
              debug:
                msg: "Hello from Ansible in Dev Spaces!"
        EOF
      workingDir: ${PROJECTS_ROOT}/basic-devspace
      group:
        kind: build

  - id: run-ansible-playbook
    exec:
      component: universal-developer-image
      commandLine: ansible-playbook hello.yml -i localhost,
      workingDir: ${PROJECTS_ROOT}/basic-devspace
      group:
        kind: run
        isDefault: true

events:
  postStart:
    - install-ansible
    - create-sample-playbook
